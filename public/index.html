<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chrono Dashboard</title>
  <style>
    :root {
      --bg: #0f172a;
      --bg-card: #1e293b;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --accent-dim: #1e40af;
      --border: #334155;
      --success: #22c55e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h1 .icon {
      font-size: 28px;
    }

    .date-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .date-nav button {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .date-nav button:hover {
      background: var(--border);
    }

    .date-nav .current-date {
      font-size: 16px;
      font-weight: 500;
      min-width: 140px;
      text-align: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .stat-card .label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 600;
    }

    .stat-card .value.accent {
      color: var(--accent);
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .card h2 {
      font-size: 14px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .app-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .app-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .app-icon {
      width: 32px;
      height: 32px;
      background: var(--border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .app-info {
      flex: 1;
      min-width: 0;
    }

    .app-name {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .app-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }

    .app-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .app-duration {
      font-size: 14px;
      font-weight: 500;
      text-align: right;
      min-width: 60px;
    }

    .app-percent {
      font-size: 11px;
      color: var(--text-muted);
    }

    .hourly-chart {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 120px;
      padding-top: 20px;
    }

    .hour-bar {
      flex: 1;
      background: var(--accent-dim);
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      position: relative;
      transition: height 0.3s ease;
    }

    .hour-bar:hover {
      background: var(--accent);
    }

    .hour-bar .tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      margin-bottom: 4px;
    }

    .hour-bar:hover .tooltip {
      display: block;
    }

    .hour-labels {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }

    .hour-labels span {
      flex: 1;
      text-align: center;
      font-size: 10px;
      color: var(--text-muted);
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .status-dot.disconnected {
      background: #ef4444;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>
        <span class="icon">‚è±</span>
        Chrono
      </h1>
      <div class="date-nav">
        <button onclick="previousDay()">‚Üê Prev</button>
        <span class="current-date" id="currentDate">Today</span>
        <button onclick="nextDay()">Next ‚Üí</button>
        <button onclick="goToToday()">Today</button>
      </div>
    </header>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">Total Tracked</div>
        <div class="value accent" id="totalTracked">--</div>
      </div>
      <div class="stat-card">
        <div class="label">Active Time</div>
        <div class="value" id="activeTime">--</div>
      </div>
      <div class="stat-card">
        <div class="label">Idle Time</div>
        <div class="value" id="idleTime">--</div>
      </div>
      <div class="stat-card">
        <div class="label">Top App</div>
        <div class="value" id="topApp">--</div>
      </div>
    </div>

    <div class="main-grid">
      <div class="card">
        <h2>App Breakdown</h2>
        <div class="app-list" id="appList">
          <div class="loading">Loading...</div>
        </div>
      </div>

      <div class="card">
        <h2>Activity by Hour</h2>
        <div class="hourly-chart" id="hourlyChart"></div>
        <div class="hour-labels" id="hourLabels"></div>
      </div>
    </div>

    <footer style="margin-top: 24px; text-align: center;">
      <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Checking connection...</span>
      </div>
    </footer>
  </div>

  <script>
    const API_BASE = '/api';
    let currentDate = new Date();

    // Format duration in seconds to human readable
    function formatDuration(seconds) {
      const s = parseInt(seconds) || 0;
      const hours = Math.floor(s / 3600);
      const minutes = Math.floor((s % 3600) / 60);

      if (hours > 0) {
        return `${hours}h ${minutes}m`;
      }
      return `${minutes}m`;
    }

    // Format date for display
    function formatDate(date) {
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      if (date.toDateString() === today.toDateString()) {
        return 'Today';
      }
      if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
      }
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Get ISO date string
    function getISODate(date) {
      return date.toISOString().split('T')[0];
    }

    // Get app icon emoji based on app name
    function getAppIcon(appName) {
      const icons = {
        'firefox': 'ü¶ä',
        'chrome': 'üåê',
        'safari': 'üß≠',
        'code': 'üíª',
        'visual studio code': 'üíª',
        'xcode': 'üî®',
        'terminal': '‚¨õ',
        'ghostty': 'üëª',
        'iterm': '‚¨õ',
        'slack': 'üí¨',
        'discord': 'üí¨',
        'messages': 'üí¨',
        'mail': 'üìß',
        'notion': 'üìù',
        'figma': 'üé®',
        'spotify': 'üéµ',
        'finder': 'üìÅ',
      };

      const lower = appName.toLowerCase();
      for (const [key, icon] of Object.entries(icons)) {
        if (lower.includes(key)) return icon;
      }
      return 'üì±';
    }

    // Fetch and render data
    async function fetchData() {
      try {
        const dateStr = getISODate(currentDate);
        const response = await fetch(`${API_BASE}/stats/daily/${dateStr}`);
        const data = await response.json();

        renderStats(data);
        renderAppList(data.topApps);
        renderHourlyChart(data.byHour);
        updateStatus(true);
      } catch (error) {
        console.error('Failed to fetch data:', error);
        updateStatus(false);
      }
    }

    // Render stats cards
    function renderStats(data) {
      const total = parseInt(data.totalTracked) || 0;
      const idle = parseInt(data.totalIdle) || 0;

      document.getElementById('totalTracked').textContent = formatDuration(total + idle);
      document.getElementById('activeTime').textContent = formatDuration(total);
      document.getElementById('idleTime').textContent = formatDuration(idle);
      document.getElementById('topApp').textContent = data.topApps?.[0]?.appName || '--';
      document.getElementById('currentDate').textContent = formatDate(currentDate);
    }

    // Render app list
    function renderAppList(apps) {
      const container = document.getElementById('appList');

      if (!apps || apps.length === 0) {
        container.innerHTML = '<div class="empty-state">No activity recorded</div>';
        return;
      }

      container.innerHTML = apps.map(app => `
        <div class="app-item">
          <div class="app-icon">${getAppIcon(app.appName)}</div>
          <div class="app-info">
            <div class="app-name">${app.appName}</div>
            <div class="app-bar">
              <div class="app-bar-fill" style="width: ${app.percentage.toFixed(1)}%"></div>
            </div>
          </div>
          <div class="app-duration">
            ${formatDuration(app.totalDuration)}
            <div class="app-percent">${app.percentage.toFixed(1)}%</div>
          </div>
        </div>
      `).join('');
    }

    // Render hourly chart
    function renderHourlyChart(hourlyData) {
      const container = document.getElementById('hourlyChart');
      const labelsContainer = document.getElementById('hourLabels');

      // Create 24-hour array
      const hours = Array(24).fill(0);
      hourlyData?.forEach(h => {
        hours[parseInt(h.hour)] = parseInt(h.duration) || 0;
      });

      const maxDuration = Math.max(...hours, 1);

      container.innerHTML = hours.map((duration, hour) => {
        const height = (duration / maxDuration) * 100;
        return `
          <div class="hour-bar" style="height: ${Math.max(height, 2)}%">
            <div class="tooltip">${hour}:00 - ${formatDuration(duration)}</div>
          </div>
        `;
      }).join('');

      labelsContainer.innerHTML = [0, 6, 12, 18, 23].map(h =>
        `<span>${h}</span>`
      ).join('') + '<span></span>'.repeat(19);
    }

    // Update connection status
    function updateStatus(connected) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');

      if (connected) {
        dot.classList.remove('disconnected');
        text.textContent = 'Connected to Chrono Server';
      } else {
        dot.classList.add('disconnected');
        text.textContent = 'Unable to connect to server';
      }
    }

    // Navigation
    function previousDay() {
      currentDate.setDate(currentDate.getDate() - 1);
      fetchData();
    }

    function nextDay() {
      currentDate.setDate(currentDate.getDate() + 1);
      fetchData();
    }

    function goToToday() {
      currentDate = new Date();
      fetchData();
    }

    // Initial load
    fetchData();

    // Refresh every 30 seconds
    setInterval(fetchData, 30000);
  </script>
</body>
</html>
